

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ship.tuflow.data_files.datafileloader &mdash; SHIP 0.3.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../search.html"/>
    <link rel="top" title="SHIP 0.3.0 documentation" href="../../../../index.html"/>
        <link rel="up" title="Module code" href="../../../index.html"/> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> SHIP
          

          
          </a>

          
            
            
              <div class="version">
                0.3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">Installing the Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../overview.html#topics">Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../overview.html#introduction">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ship.html">ship package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">ship-0.3.0.dev0</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../index.html">SHIP</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      
    <li>ship.tuflow.data_files.datafileloader</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ship.tuflow.data_files.datafileloader</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd"> Summary:</span>
<span class="sd">     Deals with loading all data from ADataObject type files.</span>
<span class="sd">     </span>
<span class="sd">     This process can get quite messy so it seems sensible to have a separate</span>
<span class="sd">     factory to deal with it.</span>
<span class="sd">     </span>
<span class="sd">     See Also:</span>
<span class="sd">         ADataObject, TmfDataObject, TmfCsvDataObject, DcDataObject</span>

<span class="sd"> Author:  </span>
<span class="sd">     Duncan Runnacles</span>

<span class="sd"> Created:  </span>
<span class="sd">     01 Apr 2016</span>

<span class="sd"> Copyright:  </span>
<span class="sd">     Duncan Runnacles 2016</span>

<span class="sd"> TODO:</span>
<span class="sd">     Need to add a subfile loader for the materials csv file loader.</span>
<span class="sd">     </span>
<span class="sd">     This module needs some cleaning up still. There is quite a bit of repeated</span>
<span class="sd">     code around that could be pulled out into module level functions and used</span>
<span class="sd">     by all of the loader.</span>

<span class="sd"> Updates:</span>


<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># ship modules</span>
<span class="kn">from</span> <span class="nn">ship.data_structures.rowdatacollection</span> <span class="k">import</span> <span class="n">RowDataCollection</span>
<span class="kn">from</span> <span class="nn">ship.data_structures</span> <span class="k">import</span> <span class="n">dataobject</span> <span class="k">as</span> <span class="n">do</span>
<span class="kn">from</span> <span class="nn">ship.tuflow.tuflowfilepart</span> <span class="k">import</span> <span class="n">DataFile</span><span class="p">,</span> <span class="n">GisFile</span><span class="p">,</span> <span class="n">TuflowFile</span>
<span class="kn">from</span> <span class="nn">ship.tuflow.data_files</span> <span class="k">import</span> <span class="n">datafileobject</span> <span class="k">as</span> <span class="n">dataobj</span>
<span class="kn">from</span> <span class="nn">ship.utils</span> <span class="k">import</span> <span class="n">filetools</span>
<span class="kn">from</span> <span class="nn">ship.utils</span> <span class="k">import</span> <span class="n">utilfunctions</span> <span class="k">as</span> <span class="n">uuf</span>
<span class="kn">from</span> <span class="nn">ship.utils.dbfread</span> <span class="k">import</span> <span class="n">DBF</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


    
<div class="viewcode-block" id="loadDataFile"><a class="viewcode-back" href="../../../../ship.tuflow.data_files.html#ship.tuflow.data_files.datafileloader.loadDataFile">[docs]</a><span class="k">def</span> <span class="nf">loadDataFile</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">args_dict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;Factory function for creating DataFileObject type objects.</span>
<span class="sd">    </span>
<span class="sd">    Loads the contents of the DataFileObject based on the composition of the</span>
<span class="sd">    given object and returns the newly created DataFileObject of that type.</span>
<span class="sd">    </span>
<span class="sd">    The args_dict is a dict of key-value pairs where the key represents a </span>
<span class="sd">    placeholder used within one of the data files and the value reprents the</span>
<span class="sd">    variables that should be used to replace that value. This is common in</span>
<span class="sd">    bc_dbase file for instance where &#39;__event__&#39; may be used as a place holder</span>
<span class="sd">    with BC Event Text and BC Event Name used in the control files to define</span>
<span class="sd">    what should be used. Other options are the use of scenario and event </span>
<span class="sd">    definitions. Within these BC Event Source can be defined to associate </span>
<span class="sd">    certain placeholders with values e.g.::</span>

<span class="sd">        Define Event == 8hr</span>
<span class="sd">            BC Event Source == ~DUR~ | 8hr</span>
<span class="sd">            BC Database == ..\bc_dbase\my_bcdbase.csv</span>
<span class="sd">        End Define</span>
<span class="sd">    </span>
<span class="sd">    These are stored in the tuflow model when loaded and can be passed when </span>
<span class="sd">    loading data files to use.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        datafile(TuflowFile): FilePart to create the DataFileObject from.</span>
<span class="sd">        args_dict={}(dict): This is a dictionary of keywords and associated </span>
<span class="sd">            values that can be used to identify and replace placeholders in the</span>
<span class="sd">            source file names or column names within data files. NOTE CURRENTLY</span>
<span class="sd">            NOT USED. </span>
<span class="sd">        </span>
<span class="sd">    Return:</span>
<span class="sd">        DataFileObject: of type identified from the composition of the given</span>
<span class="sd">            TuflowFile object.</span>
<span class="sd">    </span>
<span class="sd">    Note:</span>
<span class="sd">        The args_dict is CURRENTLY NOT USED, but will be supported soon.</span>
<span class="sd">            </span>
<span class="sd">    See Also:</span>
<span class="sd">        TuflowFile</span>
<span class="sd">        DataFileObject</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">TuflowFile</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;datafile is not an instance of TuflowFile&#39;</span><span class="p">)</span>
    
    <span class="n">command</span> <span class="o">=</span> <span class="n">datafile</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;READ MI TABLE LINKS&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">GisFile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span> <span class="p">(</span><span class="s1">&#39;datafile is not an instance of GisFile&#39;</span><span class="p">)</span>
        
        <span class="n">row_data</span><span class="p">,</span> <span class="n">comments</span> <span class="o">=</span> <span class="n">readXsFile</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">XsDataObject</span><span class="p">(</span><span class="n">row_data</span><span class="p">,</span> <span class="n">datafile</span><span class="p">,</span> <span class="n">comments</span><span class="p">,</span> <span class="n">args_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xs</span>
    
    <span class="c1"># Anything else must be a DataFile instance</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">DataFile</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span> <span class="p">(</span><span class="s1">&#39;datafile is not an instance of DataFile&#39;</span><span class="p">)</span>
        
    <span class="c1"># List containing checks for the file command and them any different file</span>
    <span class="c1"># types that are dealt with under that command.</span>
    <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;READ MATERIALS FILE&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">datafile</span><span class="o">.</span><span class="n">extension</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;tmf&#39;</span><span class="p">:</span>
            <span class="n">row_data</span><span class="p">,</span> <span class="n">comments</span> <span class="o">=</span> <span class="n">readTmfFile</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
            <span class="n">tmf</span> <span class="o">=</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">TmfDataObject</span><span class="p">(</span><span class="n">row_data</span><span class="p">,</span> <span class="n">datafile</span><span class="p">,</span> <span class="n">comments</span><span class="p">,</span> <span class="n">args_dict</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tmf</span>

        <span class="k">if</span> <span class="n">datafile</span><span class="o">.</span><span class="n">extension</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
            <span class="n">row_data</span><span class="p">,</span> <span class="n">comments</span><span class="p">,</span> <span class="n">subfile_details</span> <span class="o">=</span> <span class="n">readMatCsvFile</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">args_dict</span><span class="p">)</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">MatCsvDataObject</span><span class="p">(</span><span class="n">row_data</span><span class="p">,</span> <span class="n">datafile</span><span class="p">,</span> <span class="n">comments</span><span class="p">)</span>
            
            <span class="c1"># Load any subfiles</span>
            <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">header_list</span> <span class="ow">in</span> <span class="n">subfile_details</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">mat</span><span class="o">.</span><span class="n">addSubfile</span><span class="p">(</span><span class="n">readMatSubfile</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">header_list</span><span class="p">,</span> <span class="n">args_dict</span><span class="p">))</span>
            
            <span class="k">return</span> <span class="n">mat</span>

    <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;BC DATABASE&#39;</span><span class="p">:</span>
        <span class="n">row_data</span><span class="p">,</span> <span class="n">comments</span> <span class="o">=</span> <span class="n">readBcFile</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">args_dict</span><span class="p">)</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">BcDataObject</span><span class="p">(</span><span class="n">row_data</span><span class="p">,</span> <span class="n">datafile</span><span class="p">,</span> <span class="n">comments</span><span class="p">,</span> <span class="n">args_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bc</span> 
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Command type (</span><span class="si">%s</span><span class="s1">) with extension (</span><span class="si">%s</span><span class="s1">) is not currently supported&#39;</span> 
                                    <span class="o">%</span> <span class="p">(</span><span class="n">datafile</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="n">datafile</span><span class="o">.</span><span class="n">extension</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s1">&#39;Command type (</span><span class="si">%s</span><span class="s1">) with extension (</span><span class="si">%s</span><span class="s1">) is not currently supported&#39;</span> 
                                    <span class="o">%</span> <span class="p">(</span><span class="n">datafile</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="n">datafile</span><span class="o">.</span><span class="n">extension</span><span class="p">))</span></div>


<div class="viewcode-block" id="readXsFile"><a class="viewcode-back" href="../../../../ship.tuflow.data_files.html#ship.tuflow.data_files.datafileloader.readXsFile">[docs]</a><span class="k">def</span> <span class="nf">readXsFile</span><span class="p">(</span><span class="n">datafile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads the contents of the estry 1d_xs file reference by datafile.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value_separator</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">comment_types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xs_enum</span> <span class="o">=</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">XsEnum</span><span class="p">()</span>
    
    
    <span class="k">def</span> <span class="nf">loadShapeFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads cross section data from Shapefile .dbf format.</span>
<span class="sd">        </span>
<span class="sd">        Uses the dbfreader library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">DBF</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unable to load file at: &#39;</span> <span class="o">+</span> <span class="n">file_path</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">IOError</span> <span class="p">(</span><span class="s1">&#39;Unable to load file at: &#39;</span> <span class="o">+</span> <span class="n">file_path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">records</span><span class="p">):</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="c1"># Need to catch the fact that skew does not exist in some versions.</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs_enum</span><span class="o">.</span><span class="n">ITERABLE</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;1d_xs does not have skew column - adding default value&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs_enum</span><span class="o">.</span><span class="n">ITERABLE</span><span class="p">)):</span>
                    <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

<span class="c1">#             print t[&#39;Source&#39;] + &#39; : &#39; + t[&#39;Type&#39;] + &#39; : &#39; + t[&#39;Column_1&#39;]</span>
            <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="s1">&#39;row_no&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">row_collection</span>
    
    
    <span class="k">def</span> <span class="nf">loadMapinfoFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load cross section data from Mapinfo .mid format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
                <span class="n">csv_file</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csv_file</span><span class="p">):</span>

                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                        <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
                    
                    <span class="c1"># Need to catch the fact that skew does not exist in some versions.</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs_enum</span><span class="o">.</span><span class="n">ITERABLE</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;1d_xs does not have skew column - adding deafult value&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs_enum</span><span class="o">.</span><span class="n">ITERABLE</span><span class="p">)):</span>
                            <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="c1">#                 print row[0] + &#39; : &#39; + row[1] + &#39; : &#39; + row[3]</span>
                    <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="s1">&#39;row_no&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unable to load file at: &#39;</span> <span class="o">+</span> <span class="n">file_path</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">IOError</span> <span class="p">(</span><span class="s1">&#39;Unable to load file at: &#39;</span> <span class="o">+</span> <span class="n">file_path</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">row_collection</span>
    
    
    <span class="k">def</span> <span class="nf">setupRowCollection</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Setup the RowDataCollection for loading the data into.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First entry doesn&#39;t want to have a comma in front when formatting.</span>
        <span class="n">row_collection</span> <span class="o">=</span> <span class="n">RowDataCollection</span><span class="p">()</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Do the first entry separately because it has a different format string</span>
        <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">StringData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">StringData</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;, </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">FloatData</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;, </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">no_of_dps</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.00</span><span class="p">))</span>

        <span class="c1"># Add a couple of extra rows to the row_collection for tracking the</span>
        <span class="c1"># data in the file. </span>
        <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">IntData</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;row_no&#39;</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">row_collection</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Main Section</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">row_collection</span> <span class="o">=</span> <span class="n">setupRowCollection</span><span class="p">()</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">datafile</span><span class="o">.</span><span class="n">extension</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">datafile</span><span class="o">.</span><span class="n">absolutePath</span><span class="p">()</span>
    
    <span class="c1"># If we&#39;re loading a MapInfo mid/mif file</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;mif&#39;</span> <span class="ow">or</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;mid&#39;</span><span class="p">:</span>
        
        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;mif&#39;</span><span class="p">:</span>
            <span class="nb">dir</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.mid&#39;</span><span class="p">)</span>

        <span class="n">row_collection</span> <span class="o">=</span> <span class="n">loadMapinfoFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">)</span>
    
    <span class="c1"># If we&#39;re loading a Shapefile</span>
    <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;shp&#39;</span> <span class="ow">or</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;dbf&#39;</span><span class="p">:</span> 

        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;shp&#39;</span><span class="p">:</span>
            <span class="nb">dir</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.dbf&#39;</span><span class="p">)</span>

        <span class="n">row_collection</span> <span class="o">=</span> <span class="n">loadShapeFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Invalid file extension for XS type in file: &#39;</span> <span class="o">+</span> <span class="n">datafile</span><span class="o">.</span><span class="n">filenameAndExtension</span><span class="p">())</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s1">&#39;Invalid file extension for XS type in file: &#39;</span> <span class="o">+</span> <span class="n">datafile</span><span class="o">.</span><span class="n">filenameAndExtension</span><span class="p">())</span>
    
    <span class="c1"># Always return an empty comments list because there will never be any.</span>
    <span class="k">return</span> <span class="n">row_collection</span><span class="p">,</span> <span class="p">[]</span></div>
    
 

<div class="viewcode-block" id="readBcFile"><a class="viewcode-back" href="../../../../ship.tuflow.data_files.html#ship.tuflow.data_files.datafileloader.readBcFile">[docs]</a><span class="k">def</span> <span class="nf">readBcFile</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">args_dict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;Loads the contents of the BC Database file refernced by datafile.</span>
<span class="sd">    </span>
<span class="sd">    Loads the data from the file referenced by the given TuflowFile object into</span>
<span class="sd">    a :class:&#39;rowdatacollection&#39; and a list of comment only lines.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        datafile(TuflowFile): TuflowFile object with file details.</span>
<span class="sd">        </span>
<span class="sd">    Return:</span>
<span class="sd">        tuple: rowdatacollection, comment_lines(list).</span>
<span class="sd">        </span>
<span class="sd">    See Also:</span>
<span class="sd">        :class:&#39;rowdatacollection&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value_seperator</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">comment_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;!&#39;</span><span class="p">]</span>
    <span class="n">bc_enum</span> <span class="o">=</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">BcEnum</span><span class="p">()</span>
    <span class="n">bc_event_data</span> <span class="o">=</span> <span class="n">args_dict</span>
    
    <span class="k">def</span> <span class="nf">_checkHeaders</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">required_headers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks that any required headers can be found.</span>
<span class="sd">        </span>
<span class="sd">        Reviews the headers in the header row of the csv file to ensure that</span>
<span class="sd">        any specifically needed named column headers exist.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            row(list): columns headers.</span>
<span class="sd">            required_headers(list): column names that must be included.</span>
<span class="sd">        </span>
<span class="sd">        Return:</span>
<span class="sd">            list if some headers not found of False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check what we have in the header row</span>
        <span class="n">head_check</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">required_headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                <span class="n">head_check</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">head_check</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Required header (&#39;</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="s1">&#39;) not&#39;</span> <span class="o">+</span> 
                <span class="s1">&#39;found in file: &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">head_check</span>


    <span class="k">def</span> <span class="nf">_loadHeadData</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">,</span> <span class="n">required_headers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads the column header data.</span>
<span class="sd">        </span>
<span class="sd">        Adds the file defined names for the headers to the rowdatacollection.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            row(list): containing the row data.</span>
<span class="sd">            row_collection(rowdatacollection): for updating.</span>
<span class="sd">            required_headers(list): column names that must exist.</span>
<span class="sd">        </span>
<span class="sd">        Return:</span>
<span class="sd">            rowdatacollection: updated with header row details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">row_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">head_check</span> <span class="o">=</span> <span class="n">_checkHeaders</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">required_headers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bc_enum</span><span class="o">.</span><span class="n">ITERABLE</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">row_length</span><span class="p">:</span>
                <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="s1">&#39;actual_header&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> 
        
        <span class="k">return</span> <span class="n">row_collection</span>


    <span class="k">def</span> <span class="nf">_loadRowData</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">row_count</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;Loads the data in a specific row of the file.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            row(list): containing the row data.</span>
<span class="sd">            row_count(int): the current row number.</span>
<span class="sd">            required_headers(list): column names that must exist.</span>

<span class="sd">        Return:</span>
<span class="sd">            rowdatacollection: updated with header row details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;!&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="c1"># Add the row data in the order that it appears in the file</span>
        <span class="c1"># from left to right.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bc_enum</span><span class="o">.</span><span class="n">ITERABLE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">row_collection</span>

    
    <span class="c1"># Initialise the RowDataOjectCollection object with currect setup</span>
    <span class="n">row_collection</span> <span class="o">=</span> <span class="n">RowDataCollection</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bc_enum</span><span class="o">.</span><span class="n">ITERABLE</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">StringData</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">StringData</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;, </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    
    <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">StringData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;actual_header&#39;</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;, </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">IntData</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;row_no&#39;</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        
    <span class="n">path</span> <span class="o">=</span> <span class="n">datafile</span><span class="o">.</span><span class="n">absolutePath</span><span class="p">()</span>
    <span class="n">required_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading data file contents from disc - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rU&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
            <span class="n">csv_file</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
                    

            <span class="c1"># Stores the comments found in the file</span>
            <span class="n">comment_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">first_data_line</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">row_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Loop through the contents list loaded from file line-by-line.</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                
                <span class="n">comment</span> <span class="o">=</span> <span class="n">hasCommentOnlyLine</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">comment_types</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">comment</span> <span class="ow">or</span> <span class="n">comment</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">comment_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>

                <span class="c1"># If we have a line that isn&#39;t a comment or a blank then it is going</span>
                <span class="c1"># to contain materials entries.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># First non-comment is the headers</span>
                    <span class="k">if</span> <span class="n">first_data_line</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">first_data_line</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">row_collection</span> <span class="o">=</span> <span class="n">_loadHeadData</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">,</span> <span class="n">required_headers</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">row_collection</span> <span class="o">=</span> <span class="n">_loadRowData</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">)</span>
                        <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="s1">&#39;row_no&#39;</span><span class="p">,</span> <span class="n">row_count</span><span class="p">)</span>
                        <span class="n">row_count</span> <span class="o">+=</span> <span class="mi">1</span>                        
                    
                    <span class="n">comment_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cannot load file - IOError&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">IOError</span> <span class="p">(</span><span class="s1">&#39;Cannot load file at: &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
 
    <span class="c1"># Just need to reset the has_changed variable because it will have been</span>
    <span class="c1"># set to True while loading everything in.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bc_enum</span><span class="o">.</span><span class="n">ITERABLE</span><span class="p">)):</span>
        <span class="n">row_collection</span><span class="o">.</span><span class="n">dataObject</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">has_changed</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">return</span> <span class="n">row_collection</span><span class="p">,</span> <span class="n">comment_lines</span></div>


<div class="viewcode-block" id="readMatCsvFile"><a class="viewcode-back" href="../../../../ship.tuflow.data_files.html#ship.tuflow.data_files.datafileloader.readMatCsvFile">[docs]</a><span class="k">def</span> <span class="nf">readMatCsvFile</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">args_dict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;Loads the contents of the Materials CSV file referenced by datafile.</span>
<span class="sd">    </span>
<span class="sd">    Loads the data from the file referenced by the given TuflowFile object into</span>
<span class="sd">    a :class:&#39;rowdatacollection&#39; and a list of comment only lines.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        datafile(TuflowFile): TuflowFile object with file details.</span>
<span class="sd">        </span>
<span class="sd">    Return:</span>
<span class="sd">        tuple: rowdatacollection, comment_lines(list).</span>
<span class="sd">        </span>
<span class="sd">    See Also:</span>
<span class="sd">        :class:&#39;rowdatacollection&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value_seperator</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">comment_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;!&#39;</span><span class="p">]</span>
    <span class="n">csv_enum</span> <span class="o">=</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">MatCsvEnum</span><span class="p">()</span>
    <span class="n">subfile_details</span><span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_loadHeadData</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_row</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">12</span>

        <span class="k">if</span> <span class="s1">&#39;!&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            
        <span class="n">new_row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">new_row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">new_row</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">new_row</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">row_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_row</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_row</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">row_length</span><span class="p">:</span>
                <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="s1">&#39;actual_header&#39;</span><span class="p">,</span> <span class="n">new_row</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> 
        
        <span class="k">return</span> <span class="n">row_collection</span>

    
    <span class="k">def</span> <span class="nf">_disectEntry</span><span class="p">(</span><span class="n">col_no</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">new_row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Breaks the row values into the appropriate object values.</span>
<span class="sd">        </span>
<span class="sd">        The materials file can have Excel style sub-values. i.e. it can have</span>
<span class="sd">        seperate columns defined within a bigger one. This function will break</span>
<span class="sd">        those values down into a format usable by the values initiated in the</span>
<span class="sd">        rowdatacollection.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            col_no(int): the current column number.</span>
<span class="sd">            entry(string): the value of the current column.</span>
<span class="sd">            new_row(list): the row values to update.</span>
<span class="sd">            </span>
<span class="sd">        Return:</span>
<span class="sd">            list containing the updated row values.</span>
<span class="sd">        </span>
<span class="sd">        Note:</span>
<span class="sd">            This isn&#39;t very nice. Need to clean it up and find a better, safer</span>
<span class="sd">            way of dealing with breaking the row data up. It may be excess work</span>
<span class="sd">            but perhaps creating an xml converter could work quite will and</span>
<span class="sd">            make dealing with the file a bit easier?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">made_change</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Put in ID and Hazard as normal</span>
        <span class="k">if</span> <span class="n">col_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
        <span class="k">elif</span> <span class="n">col_no</span> <span class="o">==</span> <span class="mi">11</span><span class="p">:</span>
            <span class="n">new_row</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
        <span class="c1"># Possible break up Manning&#39;s entry further</span>
        <span class="k">elif</span> <span class="n">col_no</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># See if there&#39;s more than one value in the Manning&#39;s category.</span>
            <span class="n">splitval</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
             
            <span class="c1"># If there is and it&#39;s numeric then it&#39;s a single value for &#39;n&#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitval</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">uuf</span><span class="o">.</span><span class="n">isNumeric</span><span class="p">(</span><span class="n">splitval</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">new_row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">splitval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
             
                <span class="c1"># Otherwise it&#39;s a filename. These can be further separated </span>
                <span class="c1"># into two column headers to read from the sub files.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">strsplit</span> <span class="o">=</span> <span class="n">splitval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strsplit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">subfile_details</span><span class="p">[</span><span class="n">strsplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">new_row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">strsplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">strsplit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">subfile_details</span><span class="p">[</span><span class="n">strsplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">strsplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                        <span class="n">new_row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">strsplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">new_row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">strsplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">subfile_details</span><span class="p">[</span><span class="n">strsplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">strsplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">strsplit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                        <span class="n">new_row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">strsplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">new_row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">strsplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">new_row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">strsplit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                          
            <span class="c1"># If there&#39;s more than one value then it must be the Manning&#39;s</span>
            <span class="c1"># depth curve values (N1, Y1, N2, Y2).</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">splitval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">new_row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">splitval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">new_row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">splitval</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">new_row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">splitval</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># Finally grab the infiltration parameters (IL, CL)</span>
        <span class="k">elif</span> <span class="n">col_no</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">splitval</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">new_row</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">splitval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">new_row</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">splitval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        
        <span class="k">return</span> <span class="n">new_row</span>


    <span class="k">def</span> <span class="nf">_loadRowData</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">row_count</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;Loads the data in a specific row of the file.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            row(list): containing the row data.</span>
<span class="sd">            row_count(int): the current row number.</span>
<span class="sd">            required_headers(list): column names that must exist.</span>

<span class="sd">        Return:</span>
<span class="sd">            rowdatacollection: updated with header row details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;!&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">new_row</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">12</span>
        
        <span class="c1"># Add the row data in the order that it appears in the file</span>
        <span class="c1"># from left to right.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">csv_enum</span><span class="o">.</span><span class="n">ITERABLE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                <span class="n">new_row</span> <span class="o">=</span> <span class="n">_disectEntry</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new_row</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_row</span><span class="p">):</span>
            <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        

    <span class="c1"># First entry doesn&#39;t want to have a comma in front when formatting.</span>
    <span class="n">row_collection</span> <span class="o">=</span> <span class="n">RowDataCollection</span><span class="p">()</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Do the first entry separately because it has a different format string</span>
    <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">StringData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">StringData</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;, </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">FloatData</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;, </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">no_of_dps</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>

    <span class="c1"># Add a couple of extra rows to the row_collection for tracking the</span>
    <span class="c1"># data in the file. </span>
    <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">StringData</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">StringData</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;actual_header&#39;</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">IntData</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;row_no&#39;</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">datafile</span><span class="o">.</span><span class="n">absolutePath</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading data file contents from disc - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
            <span class="n">csv_file</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
                    

            <span class="c1"># Stores the comments found in the file</span>
            <span class="n">comment_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">first_data_line</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">line_count</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Loop through the contents list loaded from file line-by-line.</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                    
                    <span class="n">comment</span> <span class="o">=</span> <span class="n">hasCommentOnlyLine</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">comment_types</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">comment</span> <span class="ow">or</span> <span class="n">comment</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">comment_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>

                    <span class="c1"># If we have a line that isn&#39;t a comment or a blank then it is going</span>
                    <span class="c1"># to contain materials entries.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># First non-comment is the headers</span>
                        <span class="k">if</span> <span class="n">first_data_line</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="n">first_data_line</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">_loadHeadData</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">_loadRowData</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">)</span>
                        
                        <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="s1">&#39;row_no&#39;</span><span class="p">,</span> <span class="n">line_count</span><span class="p">)</span>
                        <span class="n">line_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">comment_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;This file is not setup/formatted correctly for a Materials.CSV file:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">IndexError</span> <span class="p">(</span><span class="s1">&#39;File is not correctly formatted for a Materials.csv file&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;This file is not setup/formatted correctly for a Materials.CSV file:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span> <span class="p">(</span><span class="s1">&#39;File is not correctly formatted for a Materials.csv file&#39;</span><span class="p">)</span>
    
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cannot load file - IOError&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">IOError</span> <span class="p">(</span><span class="s1">&#39;Cannot load file at: &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>

    <span class="c1"># Just need to reset the has_changed variable because it will have been</span>
    <span class="c1"># set to True while loading everything in.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">csv_enum</span><span class="o">.</span><span class="n">ITERABLE</span><span class="p">)):</span>
        <span class="n">row_collection</span><span class="o">.</span><span class="n">getDataObject</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">has_changed</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">return</span> <span class="n">row_collection</span><span class="p">,</span> <span class="n">comment_lines</span><span class="p">,</span> <span class="n">subfile_details</span></div>


<div class="viewcode-block" id="readMatSubfile"><a class="viewcode-back" href="../../../../ship.tuflow.data_files.html#ship.tuflow.data_files.datafileloader.readMatSubfile">[docs]</a><span class="k">def</span> <span class="nf">readMatSubfile</span><span class="p">(</span><span class="n">main_datafile</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">header_list</span><span class="p">,</span> <span class="n">args_dict</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value_separator</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">comment_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;!&#39;</span><span class="p">]</span>
    <span class="n">mat_subfile_enum</span> <span class="o">=</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">SubfileMatEnum</span><span class="p">()</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">main_datafile</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">main_datafile</span><span class="o">.</span><span class="n">root</span>
    
    <span class="n">header1</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
    <span class="n">header2</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">header1</span> <span class="o">=</span> <span class="n">header_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">header2</span> <span class="o">=</span> <span class="n">header_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">_scanfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scans the file before we do any loading to identify the contents.</span>
<span class="sd">        Need to do this because the file can be setup in so many way that it</span>
<span class="sd">        becomes a headache to work it out in advance. Better to take a little</span>
<span class="sd">        bit of extra processing time and do some quick checks first.</span>
<span class="sd">         </span>
<span class="sd">        Arguments:</span>
<span class="sd">            file_path (str): the path to the subfile.</span>
<span class="sd">        </span>
<span class="sd">        Return:</span>
<span class="sd">            tuple:</span>
<span class="sd">                 list: booleans with whether the column contains</span>
<span class="sd">                       data that we want or not.</span>
<span class="sd">                 int:  length of the cols list.</span>
<span class="sd">                 list: containing all of the first row column data</span>
<span class="sd">                 int:  first row with usable data on.</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Scanning Materials file - </span><span class="si">%s</span><span class="s1">&#39;</span> 
                                        <span class="o">%</span> <span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
             
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
             
            <span class="n">csv_file</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
             
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">head_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">start_row</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> 
                <span class="k">if</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">break</span>
 
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">head_list</span> <span class="o">=</span> <span class="n">row</span>
                    <span class="k">elif</span> <span class="n">uuf</span><span class="o">.</span><span class="n">isNumeric</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
                        <span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">start_row</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">start_row</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="k">elif</span> <span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">break</span>
         
        <span class="k">return</span> <span class="n">cols</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> <span class="n">head_list</span><span class="p">,</span> <span class="n">start_row</span>
    
    
    <span class="k">def</span> <span class="nf">_loadHeadData</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">,</span> <span class="n">col_length</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_row</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">12</span>

        <span class="n">comment_indices</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">uuf</span><span class="o">.</span><span class="n">findSubstringInList</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>  
        <span class="n">comment_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">head1_location</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">head2_location</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">row_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">col_length</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">row_length</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">entry</span> <span class="o">==</span> <span class="n">header1</span><span class="p">:</span>
                    <span class="n">head1_location</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">entry</span> <span class="o">==</span> <span class="n">header2</span><span class="p">:</span>
                    <span class="n">head2_location</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="s1">&#39;actual_header&#39;</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> 
        
        <span class="k">return</span> <span class="n">row_collection</span><span class="p">,</span> <span class="n">head1_location</span><span class="p">,</span> <span class="n">head2_location</span>
    

    <span class="k">def</span> <span class="nf">_loadRowData</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">row_count</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">,</span> <span class="n">comment_lines</span><span class="p">,</span> <span class="n">col_length</span><span class="p">,</span> <span class="n">start_row</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;Loads the data in a specific row of the file.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            row(list): containing the row data.</span>
<span class="sd">            row_count(int): the current row number.</span>
<span class="sd">            required_headers(list): column names that must exist.</span>

<span class="sd">        Return:</span>
<span class="sd">            rowdatacollection: updated with header row details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Any lines that aren&#39;t headers, but are above the first row to contain</span>
        <span class="c1"># actual data will be stored as comment lines</span>
        <span class="k">if</span> <span class="n">row_count</span> <span class="o">&lt;</span> <span class="n">start_row</span><span class="p">:</span>
            <span class="n">comment_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">row_collection</span><span class="p">,</span> <span class="n">comment_lines</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comment_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="s1">&#39;!&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="c1"># Add the row data in the order that it appears in the file</span>
        <span class="c1"># from left to right.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col_length</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">row_collection</span><span class="p">,</span> <span class="n">comment_lines</span>
    
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading data file contents from disc - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
            <span class="n">csv_file</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>

            <span class="c1"># Do a quick check of the file setup</span>
            <span class="n">cols</span><span class="p">,</span> <span class="n">col_length</span><span class="p">,</span> <span class="n">head_list</span><span class="p">,</span> <span class="n">start_row</span> <span class="o">=</span> <span class="n">_scanfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            
            <span class="c1"># First entry doesn&#39;t want to have a comma in front when formatting.</span>
            <span class="c1"># but all of the others do.</span>
            <span class="n">row_collection</span> <span class="o">=</span> <span class="n">RowDataCollection</span><span class="p">()</span>
            <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">FloatData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39; </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">no_of_dps</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">FloatData</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;, </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">no_of_dps</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">StringData</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;, </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
                    
            <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">StringData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;actual_header&#39;</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">IntData</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;row_no&#39;</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>

            <span class="c1"># Stores the comments found in the file</span>
            <span class="n">comment_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">first_data_line</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Loop through the contents list loaded from file line-by-line.</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                
                <span class="n">comment</span> <span class="o">=</span> <span class="n">hasCommentOnlyLine</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">comment_types</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">comment</span> <span class="ow">or</span> <span class="n">comment</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">comment_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">comment</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>

                <span class="c1"># If we have a line that isn&#39;t a comment or a blank then it is going</span>
                <span class="c1"># to contain materials entries.</span>
                <span class="k">else</span><span class="p">:</span>                    
                    <span class="c1"># First non-comment is the headers</span>
                    <span class="k">if</span> <span class="n">first_data_line</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">first_data_line</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">row_collection</span><span class="p">,</span> <span class="n">head1_loc</span><span class="p">,</span> <span class="n">head2_loc</span> <span class="o">=</span> <span class="n">_loadHeadData</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">,</span> <span class="n">col_length</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">row_collection</span><span class="p">,</span> <span class="n">comment_lines</span> <span class="o">=</span> <span class="n">_loadRowData</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">,</span> <span class="n">comment_lines</span><span class="p">,</span> <span class="n">col_length</span><span class="p">,</span> <span class="n">start_row</span><span class="p">)</span>
                    
                    <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="s1">&#39;row_no&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cannot load file - IOError&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">IOError</span> <span class="p">(</span><span class="s1">&#39;Cannot load file at: &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
    
    <span class="n">path_holder</span> <span class="o">=</span> <span class="n">filetools</span><span class="o">.</span><span class="n">PathHolder</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
    <span class="n">mat_sub</span> <span class="o">=</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">DataFileSubfileMat</span><span class="p">(</span><span class="n">path_holder</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">,</span> <span class="n">comment_lines</span><span class="p">,</span> 
                                         <span class="n">path_holder</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">head1_loc</span><span class="p">,</span>
                                         <span class="n">head2_loc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mat_sub</span></div>


<div class="viewcode-block" id="readTmfFile"><a class="viewcode-back" href="../../../../ship.tuflow.data_files.html#ship.tuflow.data_files.datafileloader.readTmfFile">[docs]</a><span class="k">def</span> <span class="nf">readTmfFile</span><span class="p">(</span><span class="n">datafile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads the contents of the Materials CSV file referenced by datafile.</span>
<span class="sd">    </span>
<span class="sd">    Loads the data from the file referenced by the given TuflowFile object into</span>
<span class="sd">    a :class:&#39;rowdatacollection&#39; and a list of comment only lines.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        datafile(TuflowFile): TuflowFile object with file details.</span>
<span class="sd">        </span>
<span class="sd">    Return:</span>
<span class="sd">        tuple: rowdatacollection, comment_lines(list).</span>
<span class="sd">        </span>
<span class="sd">    See Also:</span>
<span class="sd">        :class:&#39;rowdatacollection&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value_separator</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">comment_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;!&#39;</span><span class="p">]</span>
    <span class="n">tmf_enum</span> <span class="o">=</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">TmfEnum</span><span class="p">()</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">datafile</span><span class="o">.</span><span class="n">absolutePath</span><span class="p">()</span>
    <span class="n">value_order</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
    
    <span class="n">row_collection</span> <span class="o">=</span> <span class="n">RowDataCollection</span><span class="p">()</span>
    <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">IntData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
        <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">FloatData</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;, </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">no_of_dps</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>

    <span class="c1"># Keep track of any comment lines and the row numbers as well</span>
    <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">StringData</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39; ! </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="n">row_collection</span><span class="o">.</span><span class="n">initCollection</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">IntData</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;row_no&#39;</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    
    <span class="n">contents</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading data file contents from disc - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">_loadFileFromDisc</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    
    <span class="c1"># Stores the comments found in the file</span>
    <span class="n">comment_lines</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Loop through the contents list loaded from file line-by-line.</span>
    <span class="n">first_data_line</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">row_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        
        <span class="n">comment</span> <span class="o">=</span> <span class="n">hasCommentOnlyLine</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">comment_types</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comment</span> <span class="ow">or</span> <span class="n">comment</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">comment_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>

        <span class="c1"># If we have a line that isn&#39;t a comment or a blank then it is going</span>
        <span class="c1"># to contain materials entries.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comment_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">row_collection</span> <span class="o">=</span> <span class="n">_loadRowData</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">row_count</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">,</span> <span class="n">tmf_enum</span><span class="o">.</span><span class="n">ITERABLE</span><span class="p">,</span> 
                                            <span class="n">comment_types</span><span class="p">,</span> <span class="n">value_separator</span><span class="p">)</span>
            <span class="n">row_count</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c1"># Just need to reset the has_changed variable because it will have been</span>
    <span class="c1"># set to True while loading everything in.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value_order</span><span class="p">)):</span>
        <span class="n">row_collection</span><span class="o">.</span><span class="n">getDataObject</span><span class="p">(</span><span class="n">value_order</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">has_changed</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">return</span> <span class="n">row_collection</span><span class="p">,</span> <span class="n">comment_lines</span></div>



<span class="k">def</span> <span class="nf">_loadRowData</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">row_number</span><span class="p">,</span> <span class="n">row_collection</span><span class="p">,</span> <span class="n">val_range</span><span class="p">,</span> <span class="n">comment_types</span><span class="p">,</span>
                                                            <span class="n">value_separator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads the data in a specific row of the file.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        line(string): row as read from file.</span>
<span class="sd">        row_number(int): the current row number.</span>
<span class="sd">        row_collection(rowdatacollection): object to update.</span>
<span class="sd">        val_range(list): Range of values to find in row.</span>
<span class="sd">        comment_types(list): characters used for commenting file.</span>
<span class="sd">        value_seperator(string): the character used to seperate entries.</span>

<span class="sd">    Return:</span>
<span class="sd">        rowdatacollection: updated with header row details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If there&#39;s a comment put it in the dict</span>
    <span class="c1"># Otherwise just set a default value</span>
    <span class="n">line</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="n">_extractInlineComment</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">comment_types</span><span class="p">)</span>
     
    <span class="c1"># Then sort out the other values on the line split by separator value</span>
    <span class="n">split_vals</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">value_separator</span><span class="p">)</span>
    <span class="n">split_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_vals</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val_range</span><span class="p">):</span>
        
        <span class="c1"># Use the value_order list to know what order the values are in.</span>
        <span class="c1"># If we have gone beyond the number of values split we can just put</span>
        <span class="c1"># default values in all the other collection data types</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">split_length</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">split_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">split_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">comment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
    <span class="n">row_collection</span><span class="o">.</span><span class="n">_addValue</span><span class="p">(</span><span class="s1">&#39;row_no&#39;</span><span class="p">,</span> <span class="n">row_number</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">row_collection</span>


<span class="k">def</span> <span class="nf">_loadFileFromDisc</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load the file at the given path.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        path(string): the absolute path to the file to load.</span>
<span class="sd">    </span>
<span class="sd">    Return:</span>
<span class="sd">        list containing the contents of the loaded file by line.</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        IOError: if the file could not be loaded for some reason.</span>
<span class="sd">   &quot;&quot;&quot;</span> 
    <span class="n">contents</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading file contents from disc&#39;</span><span class="p">)</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">filetools</span><span class="o">.</span><span class="n">getFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;ADataFileComponent cannot load file - IOError&#39;</span><span class="p">)</span>
        <span class="k">raise</span> 
    
    <span class="k">return</span> <span class="n">contents</span> 


<div class="viewcode-block" id="hasCommentOnlyLine"><a class="viewcode-back" href="../../../../ship.tuflow.data_files.html#ship.tuflow.data_files.datafileloader.hasCommentOnlyLine">[docs]</a><span class="k">def</span> <span class="nf">hasCommentOnlyLine</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">comment_types</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find if line contains only comments</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        line(string): line to check for comment only status.</span>
<span class="sd">        comment_types(list): the possible comment characters to check for.</span>
<span class="sd">    </span>
<span class="sd">    Return:</span>
<span class="sd">        String containing line if True or False if not.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">first_char</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()[:</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">first_char</span> <span class="ow">in</span> <span class="n">comment_types</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">comment</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<span class="k">def</span> <span class="nf">_extractInlineComment</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">comment_types</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find if there&#39;s a comment on the line and extract it if there is.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        line(string): the file line to be checked.</span>
<span class="sd">        comment_types(list): containing possible comment characters.</span>
<span class="sd">    </span>
<span class="sd">    Return:</span>
<span class="sd">        tuple containing the line without the comment parts and the</span>
<span class="sd">            rest of the data values on the line (comment, rest-of-line)</span>
<span class="sd">   &quot;&quot;&quot;</span> 
    <span class="n">comment</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comment_types</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">split_comment</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">split_comment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="n">split_comment</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">line</span><span class="p">,</span> <span class="n">comment</span>


</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Duncan Runnacles.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'0.3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>